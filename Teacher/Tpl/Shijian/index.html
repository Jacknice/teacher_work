<include file="Public:header" />

<!-- 添加实践教学模态框（Modal） -->
<div class="modal fade" id="add_shijian" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content animated flipInX">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				<h4 class="modal-title">添加实践教学</h4>
			</div>
			<div class="modal-body" style="overflow: hidden">
				<div>
					<form class="form-horizontal" id="add_sj">
						<div class="col-lg-6" style="border-right: 1px solid #ddd;padding-right:5em">
							<div class="form-group">
								<label class="col-sm-6 control-label">环节名称：</label>

								<div class="col-sm-6">
									<input type="text" class="form-control" name="class_name" form="add_sj" required>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-6 control-label">环节学分：</label>

								<div class="col-sm-6">
									<input type="number" min="0" class="form-control" name="class_type" form="add_sj">
								</div>
							</div>

							<div class="form-group">
								<label class="col-sm-6 control-label">年级：</label>

								<div class="col-sm-6">
									<input list="nianji" class="form-control" name="study_time" form="add_sj">
									<datalist id="nianji">
                                        <option>2017</option>
                                        <option>2016</option>
                                        <option>2015</option>
                                        <option>2014</option>
                                    </datalist>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-6 control-label">专业：</label>

								<div class="col-sm-6">
									<input type="text" class="form-control" name="nianji" form="add_sj">
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-6 control-label">行政班级：</label>

								<div class="col-sm-6">
									<input type="text" class="form-control" name="zhuanye" form="add_sj">
								</div>
							</div>
						</div>
						<div class="col-lg-6">
							<div class="form-group">
								<label class="col-sm-6 control-label">学生人数：</label>

								<div class="col-sm-6">
									<input type="number" min="0" class="form-control" name="banji" form="add_sj">
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-6 control-label">环节周数：</label>

								<div class="col-sm-6">
									<input type="number" min="0" class="form-control" name="kaishi" form="add_sj">
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-6 control-label">起止周数：</label>

								<div class="col-sm-6">
									<input type="text" class="form-control" name="stu_num" form="add_sj">
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-6 control-label">环节类别：</label>

								<div class="col-sm-6">
									<!--<input list="huanjie" min="0" class="form-control" name="score" form="add_sj">
                                	<datalist class="category" id="huanjie">
                                        <option>实习</option>
                                        <option>课程设计</option>
                                        <option>其他</option>
                                    </datalist>-->
									<div id="category"></div>
								</div>
							</div>
						</div>
						<br/>
					</form>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" id='close'>关闭</button>
				<button type="button" class="add_shijian btn btn-primary">添加</button>
			</div>
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal-dialog -->
</div>

<!--页面显示全部-->
<div id="wrapper">
	<!-- 左边导航部分/.modal -->
	<include file="Public:left" />
	<!--右边显示部分-->
	<div id="page-wrapper" class="gray-bg dashbard-1">
		<include file="Public:top" />
		<!--实践教学-->
		<div id="graduate_info_pass" class="right" style="display: block;">
			<div class="row wrapper border-bottom white-bg page-heading">
				<div class="col-lg-10">
					<h2>实践教学审核表</h2>
					<ol class="breadcrumb">
						<li>
							<a href="index.html">主页</a>
						</li>
						<li>
							<a>实践教学信息审核</a>
						</li>
					</ol>
				</div>
				<div class="col-lg-2">

				</div>
			</div>
			<div class="wrapper wrapper-content animated fadeInRight">
				<div class="row">
					<div class="col-lg-12">
						<div class="ibox float-e-margins">
							<div class="ibox-title">
								<h5>实践教学信息表格</h5>

								<div class="ibox-tools">
									<a class="collapse-link">
										<i class="fa fa-chevron-up"></i>
									</a>
									<a class="dropdown-toggle" data-toggle="dropdown" href="table_data_tables.html#">
										<i class="fa fa-wrench"></i>
									</a>
									<ul class="dropdown-menu dropdown-user">
										<li>
											<a href="#">选项1</a>
										</li>
										<li>
											<a href="#">选项2</a>
										</li>
									</ul>
									<a class="close-link">
										<i class="fa fa-times"></i>
									</a>
								</div>
							</div>
							<div class="ibox-content">
								<div>
									<a onclick="update(this);" href="javascript:void(0);" class="btn btn-success" data-toggle="modal" data-target="#add_shijian"><span class="glyphicon glyphicon-plus"></span>添加实践教学</a>&nbsp;&nbsp;
									<p style="font-size: 20px;vertical-align: middle" class=" glyphicon glyphicon-hand-left"></p>&nbsp;实践环节遗漏
								</div>
								<table id="shijian" class="table table-striped table-bordered table-hover ">
									<thead>
										<tr>
											<th class="text-center">环节</th>
											<th class="text-center">学分</th>
											<th class='text-center'>环节类别</th>
											<th class='text-center'>年级</th>
											<th class='text-center'>专业</th>
											<th class='text-center'>行政班级</th>
											<th class='text-center'>学生人数</th>
											<th class='text-center'>环节周数</th>
											<th class='text-center'>起止周数</th>
											<th class='text-center'>指导老师</th>
											<th class='text-center'>状态</th>
											<th class='text-center' style="display:none">编号</th>
											<th class='text-center'>操作</th>
										</tr>
									</thead>
									<tbody>
									</tbody>
									<tfoot>
										<tr>
											<th class="text-center">环节</th>
											<th class="text-center">学分</th>
											<th class='text-center'>环节类别</th>
											<th class='text-center'>年级</th>
											<th class='text-center'>专业</th>
											<th class='text-center'>行政班级</th>
											<th class='text-center'>学生人数</th>
											<th class='text-center'>环节周数</th>
											<th class='text-center'>起止周数</th>
											<th class='text-center'>指导老师</th>
											<th class='text-center'>状态</th>
											<th class='text-center' style="display:none">编号</th>
											<th class='text-center'>操作</th>
										</tr>
									</tfoot>
								</table>

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<include file="Public:bottom" />

<script>
	//	判断浏览器的宽度
	if(document.body.clientWidth > 1000) {
		//实践环节数据信息加载
		$('#shijian').dataTable({
			"ajax": "__URL__/do_data?name=" + localStorage.u_name,
			"columnDefs": [{
				"targets": -1,
				"data": null,
				"defaultContent": '<span title="修改"class="glyphicon glyphicon-pencil up_sj" data-toggle="modal" data-target="#add_shijian">&nbsp;</span> <span title="删除" class="glyphicon glyphicon-trash del_shijian"></span>'
			}],
		});
	}else{
		//实践环节数据信息加载
		$('#shijian').dataTable({
			"ajax": "__URL__/do_data?name=" + localStorage.u_name,
			"columnDefs": [{
				"targets": -1,
				"data": null,
				"defaultContent": '<span title="修改"class="glyphicon glyphicon-pencil up_sj" data-toggle="modal" data-target="#add_shijian">&nbsp;</span> <span title="删除" class="glyphicon glyphicon-trash del_shijian"></span>'
			}],
			"scrollX": true,
		});
	}

	//选择实践表格中的倒数二行隐藏
	setTimeout(hide, 500);

	function hide() {
		$("#shijian").find("tbody tr td:nth-child(12)").css("display", "none");
	}
	//实践教学修改图标点击事件
	$("tbody").delegate(".up_sj", 'click', function() {
		$("#add_shijian").find(".modal-title").html("修改实践教学");
		$(".add_shijian").html("修改");
		th = $(this).parent();
		var names = ['class_name', 'class_type', 'score', 'study_time', 'nianji', 'zhuanye', 'banji', 'kaishi', 'stu_num', ];
		for(var i = 0; i < 9; i++) {
			if(i == 2) {
				var n = th.siblings(`td:eq(${i})`).text();
				var value = '';
				switch(n) {
					case "实习":
						value = 10;
						break;
					case "课程设计":
						value = 20;
						break;
					case "工程训练":
						value = 30;
						break;
					case "运动训练":
						value = 40;
						break;
					case "学科竞赛":
						value = 0.8;
						break;
				}
				$(`#category>select`).val(value);
			}
			$(`input[name='${names[i]}']`).val(th.siblings(`td:eq(${i})`).text());
		}
	});
	//理论教学添加课程按钮点击
	function update(t) {
		if($(t).html().indexOf("修改课程")) {
			$("#add_class").find(".modal-title").html("添加课程");
			$(".add_class").html("添加");
		}
		if($(t).html().lastIndexOf("添加实践教学")) {
			$("#add_shijian").find(".modal-title").html("添加实践教学");
			$(".add_shijian").html("添加");
		};
		var names = ['class_name', 'score', 'nianji', 'zhuanye', 'class_type', 'banji', 'kaishi', 'stu_num', 'study_time'];
		for(var i = 0; i < 9; i++) {
			//console.log(""+$(`input[name='${names[i]}']`));
			$(`input[name='${names[i]}']`).val("");
		}
	}
	//实践教学删除图标点击事件
	$("tbody").delegate(".del_shijian", 'click', function() {
		th = $(this);
		var url = "__URL__/delect?id=" + th.parent().siblings("td:eq(11)").text();
		console.log(url);
		swal({
				title: "您确定要删除这条信息吗?",
				text: "删除后将无法恢复，请谨慎操作！",
				type: "warning",
				showCancelButton: true,
				confirmButtonColor: "#DD6B55",
				confirmButtonText: "删除",
				closeOnConfirm: false,
				closeOnCancel: false
			},
			function(isConfirm) {
				if(isConfirm) {
					$.ajax({
						url: url,
						type: "POST",
						success: function(data) {
							th.parent().parent().fadeOut("slow");
							swal("删除成功!", "您已经永久删除了这条信息。", "success")
						}
					});
				} else {
					swal("已取消", "您取消了删除操作！", "error")
				}
			}
		);
	});
	//添加实践教学按钮点击事件
	$(".add_shijian").on("click", function() {
		$(this).prev().click();
		var data = $('#add_sj').serialize() + "&score=" + $("#category>select:first-child option:selected").text() + "&value=" + $("#category>select:last-child").val();
		console.log(data);
		var str = $("#add_shijian").find(".modal-title").html();
		var num = null;
		var title = '';
		var url = '';
		if(str == "修改实践教学") {
			url = "__URL__/update";
			title = "修改成功";
			data = data + "&uname=" + localStorage.u_name + '&id=' + th.siblings(`td:eq(11)`).text();
		} else if(str == "添加实践教学") {
			url = "__URL__/add";
			title = "添加成功";
			data = data + "&uname=" + localStorage.u_name;
		}
		$.ajax({
			url: url,
			data: data,
			type: "POST",
			success: function(data) {
				if(data == 1) {
					swal({
							title: title,
							text: "已提交,等待管理员审核!!!",
							type: "success",
							showCancelButton: false,
							confirmButtonColor: "#AEDEF4",
							confirmButtonText: "确定",
							closeOnConfirm: true,
							closeOnCancel: true
						},
						function(isConfirm) {
							if(isConfirm) {
								window.location = '__URL__';
							}
						}
					);

				}
			}
		});
	})

	//判断修改和删除按钮能不能点击
	var time = setInterval(panduan, 500);

	function panduan() {
		function inner(c1, c2, c3) {
			$(`#${c1}`).find(`tbody tr td:nth-child(${c2})`).each(function(indx, val) {
				if($(this).html() == "已加入核算") {
					$(this).next().css("cursor", "not-allowed");
					$(this).next().next().children().css({
						"cursor": "not-allowed",
						"color": "#ccc"
					}).removeAttr("data-target").removeClass(`${c3}`);
				}
			});
		}
		inner("shijian", 11, "del_shijian");
		if(time > 5) {
			clearInterval(time);
		}
	}
</script>
<script>
	/*使用 HTML DOM 的方式实现联动菜单*/
	var categories = [{
		"id": 10,
		"name": '实习',
		"children": [{
			"id": 101,
			"name": '文、管、经、法（社会实践）',
			"children": [{
				"id": 0.8,
				"name": "集中式"
			}, {
				"id": 0.5,
				"name": "自主式"
			}, ]
		}, {
			"id": 102,
			"name": '艺(写生、采风)',
			"children": [{
				"id": 1.0,
				"name": "集中式"
			}, {
				"id": 0.5,
				"name": "自主式"
			}, ]
		}, {
			"id": 103,
			"name": '理、工(生产实习、认识实习)',
			"children": [{
				"id": 1.0,
				"name": "集中式"
			}, {
				"id": 0.5,
				"name": "自主式"
			}, ]
		}, ]
	}, {
		"id": 20,
		"name": '课程设计',
		"children": [{
			"id": 0.8,
			"name": '文、管、艺、经、法'
		}, {
			"id": 1.0,
			"name": '理、工'
		}, ]
	}, {
		"id": 30,
		"name": '工程训练',
		"children": [{
			"id": 1.2,
			"name": '机类'
		}, {
			"id": 1.0,
			"name": '近机类'
		}, {
			"id": 0.9,
			"name": '非机类'
		}, {
			"id": 0.8,
			"name": '非工程类'
		}]
	}, {
		"id": 40,
		"name": '运动训练',
		"children": [{
			"id": 0.8,
			"name": '体育类'
		}, ]
	}, {
		"id": 0.8,
		"name": '学科竞赛'
	}];

	function createSelect(arr) {
		//创建select
		var sel = document.createElement("select");
		//创建option，同时设置内容为"-请选择-",值为-1,再将新option追加到select下
		sel.add(new Option("-请选择-", -1));
		//遍历arr中每个商品分类对象
		for(var i = 0; i < arr.length; i++) {
			//创建option，同时设置内容为当前分类的name，值为当前分类的id，再将新option追加到select下
			sel.add(
				new Option(arr[i].name, arr[i].id)
			);
		}
		//为sel元素绑定选择事件
		sel.onchange = function() { //this->sel
				//获得当前select的父元素parent
				var parent = this.parentNode;
				//反复: 只要当前select不是parent的lastChild
				while(this != parent.lastChild) {
					//删除parent下的lastChild
					parent.removeChild(parent.lastChild);
				}

				//获得当前选中项的下标-1，保存在i中
				var i = this.selectedIndex - 1;
				if(i >= 0) { //如果i>=0
					//如果arr[i]的children不是undefined
					if(arr[i].children) {
						//调用createSelect函数，传入arr中i位置的对象的children子数组作为参数，继续创建下级select
						createSelect(arr[i].children);
					}
				}
			}
			//将select追加到id为category的div下
		document.getElementById("category")
			.appendChild(sel);
	}
	createSelect(categories);
</script>

</body>

</html>