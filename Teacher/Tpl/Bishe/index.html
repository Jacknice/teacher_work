<include file="Public:header" />

<!-- 添加毕设模态框（Modal） -->
<div class="modal fade" id="add_bishe" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content animated flipInX">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				<h4 class="modal-title">添加毕设教学</h4>
			</div>
			<div class="modal-body" style="overflow: hidden">
				<div>
					<form class="form-horizontal" id="add_bj">
						<div class="col-lg-6" style="border-right: 1px solid #ddd;padding-right:5em">
							<div class="form-group">
								<label class="col-sm-6 control-label">学期：</label>

								<div class="col-sm-6">
									<input list="xueqi" class="form-control" name="class_name" form="add_bj" required>
									<datalist id="xueqi">
                                        <option>2016-2017</option>
                                       	<option>2015-2016</option>
                                       	<option>2014-2015</option>
                                       	<option>2013-2014</option>
                                    </datalist>
								</div>
							</div>

							<div class="form-group">
								<label class="col-sm-6 control-label">学院：</label>

								<div class="col-sm-6">
									<input list="xueyuan" min="0" class="form-control" name="score" form="add_bj">
									<datalist id="xueyuan">
                                        <option>计算机学院</option>
                                        <option>软件学院</option>
                                    </datalist>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-6 control-label">学生班级：</label>

								<div class="col-sm-6">
									<input class="form-control" name="study_time" form="add_bj">
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-6 control-label">学号：</label>

								<div class="col-sm-6">
									<input type="text" class="form-control" name="nianji" form="add_bj">
								</div>
							</div>
						</div>
						<div class="col-lg-6">
							<div class="form-group">
								<label class="col-sm-6 control-label">姓名：</label>

								<div class="col-sm-6">
									<input type="text" class="form-control" name="zhuanye" form="add_bj">
								</div>
							</div>

							<div class="form-group">
								<label class="col-sm-6 control-label">毕业设计课题名称：</label>

								<div class="col-sm-6">
									<input type="text" min="0" class="form-control" name="banji" form="add_bj">
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-6 control-label">类型：</label>

								<div class="col-sm-6">
									<input list="bishe_type" min="0" class="form-control" name="kaishi" form="add_bj">
									<datalist id="bishe_type">
                                        <option>校外</option>
                                        <option>校内</option>
                                    </datalist>
								</div>
							</div>
						</div>
						<br/>
					</form>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" id='close'>关闭</button>
				<button type="button" class="add_bishe btn btn-primary">添加</button>
			</div>
		</div>
		<!-- /.modal-content -->
	</div>
	<!-- /.modal-dialog -->
</div>

<!--页面显示全部-->
<div id="wrapper">
	<!--左边显示部分-->
	<include file="Public:left" />
	<!--右边显示部分-->
	<div id="page-wrapper" class="gray-bg dashbard-1">
		<include file="Public:top" />
		<!--毕业设计管理-->
		<div id="graduation_design" class="right" style="display: block" ;>
			<div class="row wrapper border-bottom white-bg page-heading">
				<div class="col-lg-12">
					<h2>毕设管理</h2>
					<ol class="breadcrumb">
						<li>
							<a href="index.html">主页</a>
						</li>
						<li>
							<a>毕业设计管理</a>
							<li>
								<strong>毕设管理</strong>
							</li>
					</ol>
				</div>
			</div>
			<div class="wrapper wrapper-content animated fadeInRight">
				<div class="row">
					<div class="col-lg-12">
						<div class="ibox float-e-margins">
							<div class="ibox-title">
								<h5>毕设管理信息表格</h5>

								<div class="ibox-tools">
									<a class="collapse-link">
										<i class="fa fa-chevron-up"></i>
									</a>
									<a class="dropdown-toggle" data-toggle="dropdown" href="table_data_tables.html#">
										<i class="fa fa-wrench"></i>
									</a>
									<ul class="dropdown-menu dropdown-user">
										<li>
											<a href="#">选项1</a>
										</li>
										<li>
											<a href="#">选项2</a>
										</li>
									</ul>
									<a class="close-link">
										<i class="fa fa-times"></i>
									</a>
								</div>
							</div>
							<div class="ibox-content">

								<div class="">
									<a onclick="update(this);" href="javascript:void(0);" class="btn btn-success " data-toggle="modal" data-target="#add_bishe"><span class="glyphicon glyphicon-plus"></span> 添加毕设</a>
								</div>
								<table id="bishe" class="table table-striped table-bordered table-hover dataTables-example">
									<thead>
										<tr>
											<th class="text-center">学期</th>
											<th class="text-center">指导老师</th>
											<th class='text-center'>学院</th>
											<th class='text-center'>学生班级</th>
											<th class='text-center'>学号</th>
											<th class='text-center'>姓名</th>
											<th class='text-center'>毕业设计课题名称</th>
											<th class='text-center'>类型</th>
											<th class="text-center">状态</th>
											<th class="text-center" style="display: none;">编码</th>
											<th class='text-center'>操作</th>
										</tr>
									</thead>
									<tbody>

									</tbody>
									<tfoot>
										<tr>
											<th class="text-center">学期</th>
											<th class="text-center">指导老师</th>
											<th class='text-center'>学院</th>
											<th class='text-center'>学生班级</th>
											<th class='text-center'>学号</th>
											<th class='text-center'>姓名</th>
											<th class='text-center'>毕业设计课题名称</th>
											<th class='text-center'>类型</th>
											<th class="text-center">状态</th>
											<th class="text-center" style="display: none;">编码</th>
											<th class='text-center'>操作</th>
										</tr>
									</tfoot>
								</table>

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<include file="Public:bottom" />

<script>
	//选择毕设表格中的倒数二行隐藏
	setTimeout(hide, 1000);

	function hide() {
		$("#bishe").find("tbody tr td:nth-child(10)").css("display", "none");
	}
	//毕设教学修改图标点击事件
	$("tbody").delegate(".up_bj", 'click', function() {
		$("#add_bishe").find(".modal-title").html("修改毕设教学");
		$(".add_bishe").html("修改");
		th = $(this).parent();
		var names = ['class_name', 'class_type', 'score', 'study_time', 'nianji', 'zhuanye', 'banji', 'kaishi'];
		for(var i = 0; i < 8; i++) {
			$(`input[name='${names[i]}']`).val(th.siblings(`td:eq(${i})`).text());
		}
	});
	//	判断浏览器的宽度
	if(document.body.clientWidth > 1000) {
		//毕业设计数据信息加载
		$('#bishe').dataTable({
			"columnDefs": [{
				"targets": -1,
				"data": null,
				"defaultContent": "<span title='修改'class='glyphicon glyphicon-pencil up_bj' data-toggle='modal' data-target='#add_bishe'>&nbsp;</span><span title = '删除' class = 'del_bishe glyphicon glyphicon-trash'> </span >",
			}],
			"ajax": "__URL__/do_data" + "?name=" + localStorage.u_name,
		});
	}else{
		//毕业设计数据信息加载
		$('#bishe').dataTable({
			"columnDefs": [{
				"targets": -1,
				"data": null,
				"defaultContent": "<span title='修改'class='glyphicon glyphicon-pencil up_bj' data-toggle='modal' data-target='#add_bishe'>&nbsp;</span><span title = '删除' class = 'del_bishe glyphicon glyphicon-trash'> </span >",
			}],
			"ajax": "__URL__/do_data" + "?name=" + localStorage.u_name,
			"scrollX": true,
		});
	}

	//毕业设计删除图表点击事件
	$("tbody").delegate(".del_bishe", 'click', function() {
		var th = $(this);
		var url = "__URL__/delect?id=" + th.parent().siblings("td:eq(9)").text();
		swal({
				title: "您确定要删除这条信息吗?",
				text: "删除后将无法恢复，请谨慎操作！",
				type: "warning",
				showCancelButton: true,
				confirmButtonColor: "#DD6B55",
				confirmButtonText: "删除",
				closeOnConfirm: false,
				closeOnCancel: false
			},
			function(isConfirm) {
				if(isConfirm) {
					$.ajax({
						url: url,
						type: "POST",
						success: function(data) {
							th.parent().parent().fadeOut("slow");
							swal("删除成功！", "您已经永久删除了这条信息。", "success")
						}
					});
				} else {
					swal("已取消", "您取消了删除操作！", "error")
				}
			}
		);
	});

	//毕设按钮点击添加毕设按击事件
	$(".add_bishe").on("click", function() {
		$(this).prev().click();
		var data = $('#add_bj').serialize();
		var str = $("#add_bishe").find(".modal-title").html();
		var url = null;
		var title = '';
		if(str == "修改毕设教学") {
			url = "__URL__/update";
			title = "修改成功";
			data = data + "&id=" + th.siblings(`td:eq(9)`).text() + "&uname=" + localStorage.u_name;
		} else if(str == "添加毕设教学") {
			url = "__URL__/add";
			title = "添加成功";
			data = data + "&uname=" + localStorage.u_name;
		}
		$.ajax({
			url: url,
			data: data,
			type: "POST",
			success: function(data) {
				if(data == 1) {
					swal({
							title: title,
							text: "已提交,等待管理员审核!!!",
							type: "success",
							showCancelButton: false,
							confirmButtonColor: "#AEDEF4",
							confirmButtonText: "确定",
							closeOnConfirm: true,
							closeOnCancel: true
						},
						function(isConfirm) {
							if(isConfirm) {
								window.location = '__URL__';
							}
						}
					);

				}
			}
		});
	})

	//添加毕设按钮点击
	function update(t) {
		if($(t).html().indexOf("修改毕设教学")) {
			$("#add_bishe").find(".modal-title").html("添加毕设教学");
			$(".add_bishe").html("添加");
		}

		var names = ['class_name', 'score', 'nianji', 'zhuanye', 'class_type', 'banji', 'kaishi', 'stu_num', 'study_time'];
		for(var i = 0; i < 9; i++) {
			//console.log(""+$(`input[name='${names[i]}']`));
			$(`input[name='${names[i]}']`).val("");
		}
	}
	//判断修改和删除按钮能不能点击
	var time = setInterval(panduan, 800);

	function panduan() {
		function inner(c1, c2, c3) {
			$(`#${c1}`).find(`tbody tr td:nth-child(${c2})`).each(function(indx, val) {
				if($(this).html() == "已加入核算") {
					$(this).next().css("cursor", "not-allowed");
					$(this).next().next().children().css({
						"cursor": "not-allowed",
						"color": "#ccc"
					}).removeAttr("data-target").removeClass(`${c3}`);
				}
			});
		}
		inner("bishe", 9, "del_bishe");
		if(time > 5) {
			clearInterval(time);
		}
	}
</script>

</body>

</html>